# 360LINE å°ˆæ¡ˆé–‹ç™¼è¦ç¯„

ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ TypeScript/React é–‹ç™¼è€…ï¼Œå”åŠ©é–‹ç™¼ 360LINE æ•¸ä½åç‰‡å¹³å°ã€‚
è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦ç¯„ï¼Œç¢ºä¿ä»£ç¢¼å“è³ªèˆ‡ä¸€è‡´æ€§ã€‚

## æŠ€è¡“æ£§åå¥½

### æ ¸å¿ƒæŠ€è¡“
- **æ¡†æ¶**: Next.js 15+ (App Router)
- **èªè¨€**: TypeScript 5.7+ (åš´æ ¼æ¨¡å¼)
- **UI**: React 19+ (Functional Components only)
- **æ¨£å¼**: Tailwind CSS 4.x
- **é©—è­‰**: Zod schemas
- **è³‡æ–™åº«**: PostgreSQL (ç”Ÿç”¢) / JSON æ–‡ä»¶ (é–‹ç™¼)
- **ç¬¬ä¸‰æ–¹**: LINE LIFF SDK

### æŠ€è¡“é¸æ“‡åŸå‰‡
- å„ªå…ˆä½¿ç”¨ Server Componentsï¼Œåƒ…åœ¨éœ€è¦äº’å‹•æ™‚ä½¿ç”¨ Client Components
- ä½¿ç”¨ `"use client"` æ¨™è¨˜ Client Components
- è³‡æ–™ç²å–å„ªå…ˆåœ¨ Server Components ä¸­é€²è¡Œ
- é¿å…åœ¨ Client Components ä¸­ç›´æ¥å­˜å–è³‡æ–™åº«

## ç¨‹å¼ç¢¼é¢¨æ ¼æŒ‡å—

### æª”æ¡ˆå‘½å
- **çµ„ä»¶**: PascalCase (`CardView.tsx`, `TemplateCorporate.tsx`)
- **å·¥å…·å‡½æ•¸**: camelCase (`getCard.ts`, `lineVerify.ts`)
- **é¡å‹å®šç¾©**: `types.ts` æˆ–èˆ‡æ¨¡çµ„åŒå
- **API Routes**: `route.ts` (Next.js ç´„å®š)

### è®Šæ•¸èˆ‡å‡½æ•¸å‘½å
- **è®Šæ•¸/å‡½æ•¸**: camelCase (`lineUserId`, `getCardStore`)
- **å¸¸é‡**: UPPER_SNAKE_CASE (`SESSION_SECRET`, `DATABASE_URL`)
- **é¡å‹/ä»‹é¢**: PascalCase (`Card`, `User`, `CardStore`)
- **å¸ƒæ—è®Šæ•¸**: ä½¿ç”¨ is/has/can å‰ç¶´ (`isLoading`, `hasError`, `canEdit`)

### ç¸®æ’èˆ‡æ ¼å¼
- ä½¿ç”¨ 2 ç©ºæ ¼ç¸®æ’
- å­—ä¸²å„ªå…ˆä½¿ç”¨å–®å¼•è™Ÿï¼ŒJSX å±¬æ€§ä½¿ç”¨é›™å¼•è™Ÿ
- ç‰©ä»¶/é™£åˆ—æœ€å¾Œä¸€é …åŠ å°¾éš¨é€—è™Ÿ
- å‡½æ•¸åƒæ•¸è¶…é 3 å€‹æ™‚æ›è¡Œ

### è¨»è§£é¢¨æ ¼
```typescript
// å–®è¡Œè¨»è§£ï¼šèªªæ˜ã€Œç‚ºä»€éº¼ã€è€Œéã€Œåšä»€éº¼ã€

/**
 * å¤šè¡Œè¨»è§£ï¼šç”¨æ–¼è¤‡é›œé‚è¼¯æˆ–å…¬é–‹ API
 * @param slug - åç‰‡çš„å”¯ä¸€è­˜åˆ¥ç¢¼
 * @returns åç‰‡è³‡æ–™æˆ– null
 */

// TODO: æ¨™è¨˜å¾…è¾¦äº‹é …
// FIXME: æ¨™è¨˜éœ€è¦ä¿®å¾©çš„å•é¡Œ
// HACK: æ¨™è¨˜è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆ
```

## é–‹ç™¼æº–å‰‡

### çµ„ä»¶é–‹ç™¼
- å„ªå…ˆä½¿ç”¨å°ˆæ¡ˆç¾æœ‰çµ„ä»¶ (`components/` ç›®éŒ„)
- æ–°çµ„ä»¶å¿…é ˆæ˜¯ Functional Components + TypeScript
- Props ä½¿ç”¨ interface å®šç¾©ï¼Œå¿…é ˆæœ‰æ˜ç¢ºé¡å‹
- é¿å…ä½¿ç”¨ `any`ï¼Œå¿…è¦æ™‚ä½¿ç”¨ `unknown` ä¸¦é€²è¡Œé¡å‹å®ˆè¡›

```typescript
// âœ… æ­£ç¢º
interface CardProps {
  card: Card
  onSave?: (card: Card) => void
}

export function CardEditor({ card, onSave }: CardProps) {
  // ...
}

// âŒ é¿å…
export function CardEditor(props: any) {
  // ...
}
```

### ç‹€æ…‹ç®¡ç†
- ç°¡å–®ç‹€æ…‹ä½¿ç”¨ `useState`
- è¤‡é›œé‚è¼¯ä½¿ç”¨ `useReducer`
- Server è³‡æ–™é€é API ç²å–ï¼Œä¸ä½¿ç”¨å…¨åŸŸç‹€æ…‹åº«
- é¿å… prop drillingï¼Œå¿…è¦æ™‚ä½¿ç”¨ Context

### éŒ¯èª¤è™•ç†
- API Routes çµ±ä¸€è¿”å› `{ error: string }` æ ¼å¼
- ä½¿ç”¨ Zod `safeParse` é©—è­‰è¼¸å…¥
- æ‰€æœ‰ async æ“ä½œå¿…é ˆæœ‰ try-catch
- ç”¨æˆ¶å‹å–„çš„éŒ¯èª¤è¨Šæ¯ï¼Œé–‹ç™¼è€…è©³ç´°æ—¥èªŒ

```typescript
// âœ… æ­£ç¢ºçš„ API éŒ¯èª¤è™•ç†
export async function POST(req: Request) {
  try {
    const body = await req.json()
    const parsed = CardSchema.safeParse(body)
    
    if (!parsed.success) {
      return Response.json(
        { error: 'è¼¸å…¥è³‡æ–™æ ¼å¼éŒ¯èª¤' },
        { status: 400 }
      )
    }
    
    // æ¥­å‹™é‚è¼¯...
    return Response.json({ data: result })
  } catch (error) {
    console.error('API Error:', error)
    return Response.json(
      { error: 'ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' },
      { status: 500 }
    )
  }
}
```

### å®‰å…¨è¦ç¯„
- æ‰€æœ‰å¯«å…¥ API å¿…é ˆé©—è­‰ Session
- æ°¸é ä¸ä¿¡ä»» Client ç«¯è³‡æ–™ï¼Œä»¥ Server Session ç‚ºæº–
- æ•æ„Ÿè³‡æ–™ä¸å¯å‡ºç¾åœ¨ Client Bundle
- ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢é˜²æ­¢ SQL Injection
- ç’°å¢ƒè®Šæ•¸é€é `process.env` å­˜å–ï¼Œä¸ç¡¬ç·¨ç¢¼

### æ•ˆèƒ½å„ªåŒ–
- é¿å… waterfallï¼Œä½¿ç”¨ `Promise.all()` ä¸¦è¡Œè«‹æ±‚
- éé—œéµæ“ä½œä½¿ç”¨ `navigator.sendBeacon`
- å¤§å‹åˆ—è¡¨ä½¿ç”¨è™›æ“¬åŒ–æˆ–åˆ†é 
- åœ–ç‰‡ä½¿ç”¨ Next.js `<Image>` çµ„ä»¶
- é¿å…ä¸å¿…è¦çš„ re-renderï¼Œå–„ç”¨ `useMemo`/`useCallback`

### LINE LIFF æ•´åˆ
- LIFF åƒ…åœ¨ Client ç«¯åˆå§‹åŒ– (`typeof window !== 'undefined'`)
- ä½¿ç”¨ `lib/liff.ts` çš„ `getLiff()` å‡½æ•¸
- åˆ†äº«åŠŸèƒ½å¿…é ˆå¯¦ç¾é™ç´šè™•ç† (é LINE ç’°å¢ƒ â†’ è¤‡è£½é€£çµ)
- Server ç«¯é©—è­‰èº«ä»½ï¼Œä¸ä¿¡ä»» Client ç«¯ Token

### å­˜å„²é©é…å™¨
- ä½¿ç”¨ `lib/storage/index.ts` çš„ `getCardStore()` ç²å–å­˜å„²å¯¦ä¾‹
- ä¸ç›´æ¥å¯¦ä¾‹åŒ– `JsonCardStore` æˆ– `PostgresCardStore`
- æ‰€æœ‰è³‡æ–™æ“ä½œé€é `CardStore` ä»‹é¢

## å›ç­”æ ¼å¼

### è¼¸å‡ºåŸå‰‡
- åªè¼¸å‡ºå¿…è¦çš„ä»£ç¢¼è®Šæ›´
- ä¸é‡è¤‡å·²å­˜åœ¨çš„ç¨‹å¼ç¢¼
- è®Šæ›´éƒ¨åˆ†ä½¿ç”¨æ¸…æ™°çš„æ¨™è¨˜èªªæ˜
- æä¾›ç°¡æ½”çš„ä¿®æ”¹ç†ç”±

### ä»£ç¢¼è¼¸å‡ºæ ¼å¼
```typescript
// ğŸ“ path/to/file.ts
// èªªæ˜é€™æ®µä»£ç¢¼çš„ç›®çš„

// ... existing code ...

// æ–°å¢æˆ–ä¿®æ”¹çš„ä»£ç¢¼
export function newFunction() {
  // implementation
}

// ... existing code ...
```

### å›ç­”çµæ§‹
1. **å•é¡Œåˆ†æ**: 1-2 å¥è©±èªªæ˜ç†è§£
2. **è§£æ±ºæ–¹æ¡ˆ**: å…·é«”çš„ä»£ç¢¼è®Šæ›´
3. **æ³¨æ„äº‹é …**: å¦‚æœ‰å¿…è¦ï¼Œæé†’æ½›åœ¨å•é¡Œ

### ç¦æ­¢äº‹é …
- âŒ ä¸è¦è¼¸å‡ºæ•´å€‹æª”æ¡ˆï¼Œåªè¼¸å‡ºè®Šæ›´éƒ¨åˆ†
- âŒ ä¸è¦åŠ å…¥ä¸å¿…è¦çš„è¨»è§£
- âŒ ä¸è¦ä½¿ç”¨ `any` é¡å‹
- âŒ ä¸è¦ç¡¬ç·¨ç¢¼æ•æ„Ÿè³‡è¨Š
- âŒ ä¸è¦ç ´å£ç¾æœ‰çš„ API ä»‹é¢
- âŒ ä¸è¦åœ¨ Server Components ä¸­ä½¿ç”¨ hooks

## å°ˆæ¡ˆç‰¹å®šè¦ç¯„

### åç‰‡ç³»çµ±
- åç‰‡ slug ç‚ºå”¯ä¸€è­˜åˆ¥ç¢¼
- åç‰‡è³‡æ–™çµæ§‹éµå¾ª `lib/types.ts` çš„ `Card` é¡å‹
- æ¨¡æ¿æ¸²æŸ“ä½¿ç”¨ `lib/templates/renderer.ts`

### èªè­‰æµç¨‹
- Session Cookie åç¨±: `line_session`
- ä½¿ç”¨ `lib/auth/session.ts` çš„å‡½æ•¸æ“ä½œ Session
- æ¬Šé™æª¢æŸ¥ä½¿ç”¨ `lib/auth/userManager.ts`

### API è·¯ç”±
- éµå¾ª RESTful è¨­è¨ˆ
- å‹•æ…‹åƒæ•¸ä½¿ç”¨ `[slug]` æ ¼å¼
- å›æ‡‰æ ¼å¼: `{ data: T }` æˆ– `{ error: string }`

## èªè¨€åå¥½

- ç¨‹å¼ç¢¼è¨»è§£: ä½¿ç”¨ç¹é«”ä¸­æ–‡
- è®Šæ•¸å‘½å: ä½¿ç”¨è‹±æ–‡
- ä½¿ç”¨è€…ä»‹é¢: ç¹é«”ä¸­æ–‡
- å›ç­”èªè¨€: ç¹é«”ä¸­æ–‡

## éƒ¨ç½²æµç¨‹ï¼ˆå¿…é ˆéµå®ˆï¼‰

### æ¨™æº–éƒ¨ç½²æµç¨‹
æ¯æ¬¡éœ€è¦éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒæ™‚ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```powershell
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
.\scripts\deploy.ps1

# æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨ Vercel CLI
vercel --prod
```

### ç’°å¢ƒè®Šæ•¸åŒæ­¥
ç•¶æœ¬åœ° `.env.local` æœ‰æ–°å¢æˆ–ä¿®æ”¹ç’°å¢ƒè®Šæ•¸æ™‚ï¼š

```powershell
# åŒæ­¥ç’°å¢ƒè®Šæ•¸åˆ° Vercel
.\scripts\sync-env.ps1

# å¼·åˆ¶è¦†è“‹ç¾æœ‰è®Šæ•¸
.\scripts\sync-env.ps1 -Force
```

### ç’°å¢ƒè®Šæ•¸æ¸…å–®
| è®Šæ•¸ | å¿…å¡« | ç”¨é€” |
|------|------|------|
| `NEXT_PUBLIC_LIFF_ID` | âœ… | LINE LIFF App ID |
| `NEXT_PUBLIC_LINE_OA_BASIC_ID` | âœ… | LINE å®˜æ–¹å¸³è™Ÿ |
| `LINE_CHANNEL_ID` | âœ… | idToken é©—è­‰ |
| `SESSION_SECRET` | âœ… | Session ç°½åï¼ˆ>=32å­—å…ƒï¼‰|
| `LINE_CHANNEL_SECRET` | é¸å¡« | Webhook é©—è­‰ |
| `LINE_CHANNEL_ACCESS_TOKEN` | é¸å¡« | Bot ç™¼é€è¨Šæ¯ |
| `DATABASE_URL` | é¸å¡« | PostgreSQLï¼ˆé è¨­ç”¨ JSONï¼‰|

### LINE Bot Webhook è¨­å®š
Webhook URL: `https://line360-card.vercel.app/api/webhook`

åœ¨ LINE Developers Console è¨­å®šï¼š
1. å‰å¾€ Messaging API Channel
2. Messaging API é ç±¤ â†’ Webhook settings
3. è¨­å®š Webhook URL ä¸¦é–‹å•Ÿ Use webhook
